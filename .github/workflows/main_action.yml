name: Daily GTFS Fetch and Schedule Generation

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write 

jobs:
  fetch_and_commit:
    name: Running on BusTimes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # *** הוסר השלב sudo apt-get install -y ca-certificates ***

      - name: Install dependencies (requests, pandas, and urllib3)
        # התקנת כל הנדרש, כולל urllib3 לדיכוי אזהרות SSL
        run: |
          echo "DEBUG: Installing requests, pandas, and urllib3..."
          pip install requests pandas urllib3
          echo "DEBUG: Installation complete."

      - name: Run GTFS Download and Parsing Script and Capture Outputs
        id: run_script
        shell: bash
        run: |
          echo "DEBUG: Starting download_gtfs.py..."
          OUTPUT=$(python download_gtfs.py)
          
          echo "$OUTPUT"
          echo "DEBUG: Script finished."
          
          # 3. חילוץ המשתנים שהודפסו מה-Python וניקוי רווחים מיותרים
          COMMIT_MSG=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_COMMIT_MESSAGE:' | sed 's/ACTION_OUTPUT_COMMIT_MESSAGE://' | tr -d '\n\r' | xargs)
          FILES_TO_COMMIT=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_FILES_TO_COMMIT:' | sed 's/ACTION_OUTPUT_FILES_TO_COMMIT://' | tr -d '\n\r' | xargs)
          
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "file_pattern=$FILES_TO_COMMIT" >> $GITHUB_OUTPUT # זה יכיל או 'gtfs.zip schedule.txt' או 'gtfs.zip'
          
          echo "DEBUG: Commit message set: $COMMIT_MSG"
          echo "DEBUG: File pattern set: $FILES_TO_COMMIT"
      
      - name: Commit files if changed (GTFS.zip and schedule.txt)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ steps.run_script.outputs.commit_message }}
          # *** חזרה לשימוש בפלט הפייתון הדינמי ***
          file_pattern: ${{ steps.run_script.outputs.file_pattern }} 
          commit_options: '--allow-empty'
          skip_dirty_check: true
          
      - name: Final Success Check
        run: echo "SUCCESS - Action completed. Check the 'BusTimes' repository for the updated files."
