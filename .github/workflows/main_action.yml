name: Daily GTFS Fetch and Schedule Generation

on:
  # הרצה יומית בשעה 03:00 UTC (06:00 או 05:00 בוקר בישראל)
  schedule:
    - cron: '0 3 * * *'
  # מאפשר הרצה ידנית מהממשק הגרפי
  workflow_dispatch:

jobs:
  fetch_and_commit:
    # ודא כי הרפוזיטורי הוא BusTimes
    name: Running on BusTimes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        # מוריד את הקוד של הרפוזיטורי
        uses: actions/checkout@v4
        with:
          # חיוני כדי לאפשר לקוד לבצע Commit חדש
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        # הגדרת סביבת Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # משתמשים בגרסה יציבה
          
      - name: Install dependencies (requests and pandas)
        # התקנת ספריות Python הנדרשות
        run: |
          echo "DEBUG: Installing requests and pandas..."
          pip install requests pandas
          echo "DEBUG: Installation complete."

      - name: Run GTFS Download and Parsing Script
        # *** זהו הבלוק שתוקן כדי ללכוד את הפלט של הפייתון ***
        id: run_script
        run: |
          echo "DEBUG: Starting download_gtfs.py..."
          # הרצת הפייתון ולכידת כל הפלט
          OUTPUT=$(python download_gtfs.py)
          
          # הדפסת כל הפלט הרגיל של הפייתון
          echo "$OUTPUT"
          echo "DEBUG: Script finished."

          # חילוץ המשתנים ACTION_OUTPUT_COMMIT_MESSAGE ו-ACTION_OUTPUT_FILES_TO_COMMIT
          COMMIT_MSG=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_COMMIT_MESSAGE:' | sed 's/ACTION_OUTPUT_COMMIT_MESSAGE://')
          FILES_TO_COMMIT=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_FILES_TO_COMMIT:' | sed 's/ACTION_OUTPUT_FILES_TO_COMMIT://')
          
          # הגדרת משתני הפלט של ה-Step באמצעות התחביר הישן (שעדיין נתמך במקרים רבים)
          # או באמצעות התחביר המודרני ל-bash
          # הדרך הנכונה המודרנית (כתיבה לקובץ):
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "files_to_commit=$FILES_TO_COMMIT" >> $GITHUB_OUTPUT
          
          echo "DEBUG: Commit message extracted: $COMMIT_MSG"
          echo "DEBUG: Files to commit extracted: $FILES_TO_COMMIT"
      
      - name: Commit files if changed (GTFS.zip and schedule.txt)
        # משתמש ב-Action של צד שלישי לביצוע Add ו-Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # קורא את הפלט שהוגדר בשלב הקודם
          commit_message: ${{ steps.run_script.outputs.commit_message }}
          files: ${{ steps.run_script.outputs.files_to_commit }}
          commit_options: '--allow-empty'
          skip_dirty_check: true 
          
      - name: Final Success Check
        run: echo "SUCCESS - Action completed. Check the 'BusTimes' repository for the updated files."
