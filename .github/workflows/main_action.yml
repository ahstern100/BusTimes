name: Daily GTFS Fetch and Schedule Generation

on:
  # הרצה יומית בשעה 03:00 UTC (06:00 או 05:00 בוקר בישראל)
  schedule:
    - cron: '0 3 * * *'
  # מאפשר הרצה ידנית מהממשק הגרפי
  workflow_dispatch:

permissions:
  contents: write # הרשאה זו פותרת את שגיאת 403

jobs:
  fetch_and_commit:
    name: Running on BusTimes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        # הגדרת סביבת Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # *** הוספת שלב התיקון לבעיית SSL/CERTIFICATE ***
      - name: Ensure up-to-date SSL certificates
        run: |
          echo "DEBUG: Running apt-get update and installing ca-certificates..."
          sudo apt-get update
          sudo apt-get install -y ca-certificates
          echo "DEBUG: ca-certificates installation finished."

      - name: Install dependencies (requests, pandas)
        # שימו לב: הסרנו את urllib3, כי אנו חוזרים ל-verify=True
        run: |
          echo "DEBUG: Installing requests and pandas..."
          pip install requests pandas
          echo "DEBUG: Installation complete."

      - name: Run GTFS Download and Parsing Script and Capture Outputs
        id: run_script
        shell: bash
        run: |
          echo "DEBUG: Starting download_gtfs.py..."
          OUTPUT=$(python download_gtfs.py)
          
          echo "$OUTPUT"
          echo "DEBUG: Script finished."

          COMMIT_MSG=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_COMMIT_MESSAGE:' | sed 's/ACTION_OUTPUT_COMMIT_MESSAGE://')
          FILES_TO_COMMIT=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_FILES_TO_COMMIT:' | sed 's/ACTION_OUTPUT_FILES_TO_COMMIT://')
          
          # שימוש בתחביר המודרני ל-GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "file_pattern=$FILES_TO_COMMIT" >> $GITHUB_OUTPUT
          
          echo "DEBUG: Commit message set: $COMMIT_MSG"
          echo "DEBUG: File pattern set: $FILES_TO_COMMIT"
      
      - name: Commit files if changed (GTFS.zip and schedule.txt)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ steps.run_script.outputs.commit_message }}
          # חזרנו ל-file_pattern הנכון והבטוח
          file_pattern: ${{ steps.run_script.outputs.file_pattern }} 
          commit_options: '--allow-empty'
          skip_dirty_check: true 
          
      - name: Final Success Check
        run: echo "SUCCESS - Action completed. Check the 'BusTimes' repository for the updated files."
