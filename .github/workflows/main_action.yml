name: Daily GTFS Fetch and Schedule Generation

on:
  # הרצה יומית בשעה 03:00 UTC (06:00 או 05:00 בוקר בישראל)
  schedule:
    - cron: '0 3 * * *'
  # מאפשר הרצה ידנית מהממשק הגרפי
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch_and_commit:
    name: Running on BusTimes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies (requests and pandas)
        run: |
          echo "DEBUG: Installing requests and pandas..."
          pip install requests pandas urllib3
          echo "DEBUG: Installation complete."

      - name: Run GTFS Download and Parsing Script and Capture Outputs
        # *** תיקון: הגדרת משתני פלט באמצעות GITHUB_OUTPUT כפי שתוקן קודם ***
        id: run_script
        shell: bash
        run: |
          echo "DEBUG: Starting download_gtfs.py..."
          # 1. הרצת הפייתון ולכידת כל הפלט
          OUTPUT=$(python download_gtfs.py)
          
          # 2. הדפסת כל הפלט הרגיל של הפייתון ליומן
          echo "$OUTPUT"
          echo "DEBUG: Script finished."

          # 3. חילוץ המשתנים שהודפסו מה-Python באמצעות grep ו-sed
          # קבלת הודעת Commit
          COMMIT_MSG=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_COMMIT_MESSAGE:' | sed 's/ACTION_OUTPUT_COMMIT_MESSAGE://')
          # קבלת הקבצים ל-Commit (בפורמט מופרד בפסיקים)
          FILES_TO_COMMIT=$(echo "$OUTPUT" | grep 'ACTION_OUTPUT_FILES_TO_COMMIT:' | sed 's/ACTION_OUTPUT_FILES_TO_COMMIT://')
          
          # 4. כתיבה לקובץ GITHUB_OUTPUT (הדרך המודרנית להגדרת משתני Step Output)
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          # *** הערה: אנחנו מעבירים את רשימת הקבצים ל-file_pattern ***
          echo "file_pattern=$FILES_TO_COMMIT" >> $GITHUB_OUTPUT 
          
          echo "DEBUG: Commit message set: $COMMIT_MSG"
          echo "DEBUG: File pattern set: $FILES_TO_COMMIT"
      
      - name: Commit files if changed (GTFS.zip and schedule.txt)
        # משתמש ב-Action של צד שלישי לביצוע Add ו-Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ steps.run_script.outputs.commit_message }}
          commit_options: '--allow-empty'
          skip_dirty_check: true 
          
      - name: Final Success Check
        run: echo "SUCCESS - Action completed. Check the 'BusTimes' repository for the updated files."
